jenkins installation script ------->

sudo apt update
sudo apt install fontconfig openjdk-21-jre
java -version

sudo wget -O /etc/apt/keyrings/jenkins-keyring.asc \
  https://pkg.jenkins.io/debian-stable/jenkins.io-2026.key
echo "deb [signed-by=/etc/apt/keyrings/jenkins-keyring.asc]" \
  https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
  /etc/apt/sources.list.d/jenkins.list > /dev/null
sudo apt update
sudo apt install jenkins

sudo systemctl enable jenkins
sudo systemctl start jenkins
sudo systemctl status jenkins




dokcer installation script -------->


#!/bin/bash

# Update system
sudo apt-get update

# Install dependencies
sudo apt-get install -y ca-certificates curl

# Create keyrings directory
sudo install -m 0755 -d /etc/apt/keyrings

# Add Docker GPG key
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add Docker repository
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
$(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install Docker
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Allow docker without sudo
sudo usermod -aG docker $USER
newgrp docker

# Verify installation
docker --version
docker compose version



Step-1: Install kubectl
curl -LO https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl
chmod +x kubectl
sudo mv kubectl /usr/local/bin/
kubectl version –client


Step-2: Install AWS CLI (v2)
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
sudo apt install -y unzip
unzip awscliv2.zip
sudo ./aws/install
aws –version


Step-3: Install eksctl
curl -sLO https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_Linux_amd64.tar.gz
tar -xzf eksctl_Linux_amd64.tar.gz
sudo mv eksctl /usr/local/bin/
eksctl version


Step-4: Configure AWS credentials using this command:
aws configure

When prompted, enter:
• AWS Access Key ID
• AWS Secret Access Key
• Default region: ap-south-1
• Default output format: json



pipeline ------>


pipeline {
    agent any

    environment {
        DOCKER_HUB_REPO   = 'ayushman50/techsolutions-app'
        K8S_CLUSTER_NAME = 'kastro-cluster'
        AWS_REGION       = 'ap-south-1'
        NAMESPACE        = 'default'
        APP_NAME         = 'techsolutions'
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                git 'https://github.com/Ayushmansen500/microservices-ingress-kastro.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'Building Docker image...'
                script {
                    def buildNumber = env.BUILD_NUMBER
                    env.IMAGE_TAG = buildNumber

                    sh """
                      docker build -t ${DOCKER_HUB_REPO}:${env.IMAGE_TAG} .
                      docker tag ${DOCKER_HUB_REPO}:${env.IMAGE_TAG} ${DOCKER_HUB_REPO}:latest
                    """
                }
            }
        }

        stage('Push to DockerHub') {
            steps {
                echo 'Pushing Docker image to DockerHub...'
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'dockerhub-creds',
                            usernameVariable: 'DOCKER_USERNAME',
                            passwordVariable: 'DOCKER_PASSWORD'
                        )
                    ]) {
                        sh """
                          echo \$DOCKER_PASSWORD | docker login -u \$DOCKER_USERNAME --password-stdin
                          docker push ${DOCKER_HUB_REPO}:${env.IMAGE_TAG}
                          docker push ${DOCKER_HUB_REPO}:latest
                        """
                    }
                }
            }
        }

        stage('Configure AWS & kubeconfig') {
            steps {
                echo 'Configuring AWS and kubectl...'
                script {
                    withCredentials([
                        [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']
                    ]) {
                        sh """
                          aws sts get-caller-identity
                          aws eks update-kubeconfig \
                            --region ${AWS_REGION} \
                            --name ${K8S_CLUSTER_NAME}
                          kubectl config current-context
                          kubectl get nodes
                        """
                    }
                }
            }
        }

        stage('Deploy Application to EKS') {
            steps {
                echo 'Deploying application to Kubernetes...'
                script {
                    withCredentials([
                        [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']
                    ]) {
                        sh """
                          sed -i 's|ayushman50/techsolutions-app:latest|ayushman50/techsolutions-app:${env.IMAGE_TAG}|g' k8s/deployment.yaml
                          kubectl apply -f k8s/deployment.yaml
                          kubectl rollout status deployment/${APP_NAME}-deployment --timeout=300s
                          kubectl get pods -l app=${APP_NAME}
                          kubectl get svc ${APP_NAME}-service
                        """
                    }
                }
            }
        }

        stage('Deploy Ingress') {
            steps {
                echo 'Deploying Ingress...'
                script {
                    withCredentials([
                        [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']
                    ]) {
                        sh """
                          kubectl apply -f k8s/ingress.yaml
                          sleep 10
                          kubectl get ingress ${APP_NAME}-ingress
                          kubectl describe ingress ${APP_NAME}-ingress
                        """
                    }
                }
            }
        }

        stage('Fetch Ingress URL & Health Check') {
            steps {
                echo 'Fetching Ingress URL...'
                script {
                    withCredentials([
                        [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']
                    ]) {
                        timeout(time: 10, unit: 'MINUTES') {
                            waitUntil {
                                def hostname = sh(
                                    script: "kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'",
                                    returnStdout: true
                                ).trim()

                                if (hostname) {
                                    env.INGRESS_URL = "http://${hostname}"
                                    echo "Ingress URL: ${env.INGRESS_URL}"
                                    return true
                                }
                                return false
                            }
                        }

                        sh """
                          curl -I ${env.INGRESS_URL}/ || true
                          curl -I ${env.INGRESS_URL}/about || true
                          curl -I ${env.INGRESS_URL}/services || true
                          curl -I ${env.INGRESS_URL}/contact || true
                        """

                        echo "=========================================="
                        echo "DEPLOYMENT SUCCESSFUL"
                        echo "Application URL: ${env.INGRESS_URL}"
                        echo "=========================================="
                    }
                }
            }
        }
    }

    post {

        always {
            echo 'Cleaning up local Docker images...'
            sh "docker rmi ${DOCKER_HUB_REPO}:${env.IMAGE_TAG} || true"
            sh "docker rmi ${DOCKER_HUB_REPO}:latest || true"
        }

        success {
            echo "Pipeline completed successfully!"
            echo "Application live at: ${env.INGRESS_URL}"
        }

        failure {
            echo "Pipeline failed. Check Jenkins logs."
        }
    }
}
